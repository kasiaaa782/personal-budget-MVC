{% extends "base.html" %}

{% block title %}Budżet osobisty - Dodawanie wydatku{% endblock %}

{% block head %}

<link rel="stylesheet" href="../css/fontello.css" type="text/css">

<script>

  $(document).ready(function () {
    //changing of icons up/down
    $("#option1").click(function () {
      up = $("#up1");
      up.attr('class') == 'icon-down-open' ? up.attr("class", "icon-up-open") : up.attr("class", "icon-down-open");
      $("#up2, #up3, #up4").attr("class", "icon-down-open");
    });
    $("#option2").click(function () {
      up = $("#up2");
      up.attr('class') == 'icon-down-open' ? up.attr("class", "icon-up-open") : up.attr("class", "icon-down-open");
      $("#up1, #up3, #up4").attr("class", "icon-down-open");
    });
    $("#option3").click(function () {
      up = $("#up3");
      up.attr('class') == 'icon-down-open' ? up.attr("class", "icon-up-open") : up.attr("class", "icon-down-open");
      $("#up1, #up2, #up4").attr("class", "icon-down-open");
    });
    $("#option4").click(function () {
      up = $("#up4");
      up.attr('class') == 'icon-down-open' ? up.attr("class", "icon-up-open") : up.attr("class", "icon-down-open");
      $("#up1, #up2, #up3").attr("class", "icon-down-open");
    });

    //hover radio input    
    $("label").hover(function () {
      $(this).children().children().prop('checked', true);
    });

  });

  ajaxRemoveCategory = (idCategory, url, label) => {
    $.ajax({
      url: url,
      method: "post",
      data: { idCategory },
      success: function () {
        label.addClass("d-none");
      },
      error: function (XMLHttpRequest, textStatus, errorThrown) {
        alert("Błąd!");
      }
    });
  }

  showModalToRemoveCategory = (item, idCategory) => {
    switch (item) {
      case 'Income' : {
        $('#winIncomeModal' + idCategory).modal("show");
        $('.removeIncomeCategory').on('submit', function () {
          event.preventDefault();

          var label = $('#labelIncome' + idCategory);
          ajaxRemoveCategory(idCategory, "/Settings/removeIncomeCategory", label);

          $('#winIncomeModal' + idCategory).modal("hide");
        });
        break;
      }
      case 'Expense' : {
        $('#winExpenseModal' + idCategory).modal("show");
        $('.removeExpenseCategory').on('submit', function () {
          event.preventDefault();

          var label = $('#labelExpense' + idCategory);
          ajaxRemoveCategory(idCategory, "/Settings/removeExpenseCategory", label);

          $('#winExpenseModal' + idCategory).modal("hide");
        });
        break;
      }
      case 'Payment' : {
        $('#winPaymentModal' + idCategory).modal("show");
        $('.removePaymentCategory').on('submit', function () {
          event.preventDefault();

          var label = $('#labelPayment' + idCategory);
          ajaxRemoveCategory(idCategory, "/Settings/removePaymentCategory", label);

          $('#winPaymentModal' + idCategory).modal("hide");
        });
      }
    }
  }

  capitalizeFirstLetter = str => {
    return str.charAt(0).toUpperCase() + str.substring(1).toLowerCase();
  } 

  ajaxAddCategory = (categoryName, urlDB) => {
    $.ajax({
      url: urlDB,
      method: "post",
      data: { categoryName },
      success: function () {
        alert('zrobione!');
      },
      error: function (XMLHttpRequest, textStatus, errorThrown) {
        alert("Błąd!");
      }
    });
  }

  addCategoryToLabel = categoryName => {

    console.log(categoryName);
    /*$('#addIncomeCategoryForm').on('submit', function () {
      event.preventDefault();
      console.log(success);

      if(success){
        addCategoryToLabel(categoryName);
        $('#winModalAddCategoryIncome').modal("hide");
      } else {
        inputAddCategory.addClass('is-invalid');
      }
    });*/
  }

  showModalToAddCategory = item => {
    var infoText = $('.categoryInfo');
    var inputAddCategory = $('#inputAddCategory'+item);
    var notSuccess = true;
    var categoryName = "";
    var url = "";
    var urlDB = "";

    infoText.empty();
    inputAddCategory.removeClass('is-invalid');
    inputAddCategory.val("");

    $('#winModalAddCategory'+item).modal("show");
    
    $('#formAddCategory'+item).on('submit', function () {
      event.preventDefault();
      if(notSuccess){
        inputAddCategory.addClass('is-invalid');
      }
    });

    switch (item) {
      case 'Income' : {
        url = '/Settings/checkIncomeCategory';
        urlDB = '/Settings/addIncomeCategory';
        break;
      }
      case 'Expense' : {
        url = '/Settings/checkExpenseCategory';
        urlDB = '/Settings/addExpenseCategory';
        break;
      }
      case 'Payment' : {
        url = '/Settings/checkPaymentMethod';
        urlDB = '/Settings/addPaymentMethod';
        break;
      }
    }

    inputAddCategory.keyup(function() {
      categoryName = $(this).val();
      $.ajax({
        url: url,
        method: "post",
        data: { categoryName },
        datatype: "text",
        success: function (data) {

          if (data !== "Nazwa poprawna!") {
            infoText.removeClass('text-success').addClass('text-danger');
            notSuccess = true;
            inputAddCategory.addClass('is-invalid');
          } else {
            infoText.removeClass('text-danger').addClass('text-success');
            inputAddCategory.removeClass('is-invalid');
            notSuccess = false;
          }
          
          infoText.html(data);
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
          alert("Błąd!");
        }
      });
    });

    $('#formAddCategory'+item).on('submit', function () {
      event.preventDefault();
      if(notSuccess == false){
        categoryName = capitalizeFirstLetter(categoryName);
        ajaxAddCategory(categoryName, urlDB);
        addCategoryToLabel(categoryName);
        $('#winModalAddCategory'+item).modal("hide");
      }
    });
  }

</script>

{% endblock %}

{% block navigation %}

<nav class="navbar navbar-dark navbar-expand-lg">
  <button class="navbar-toggler mx-auto" type="button" data-toggle="collapse" data-target="#mainmenu"
    aria-controls="mainmenu" aria-expanded="false" aria-label="Przełącznik nawigacji">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="mainmenu">
    <ol class="navbar-nav mx-auto">
      <li class="nav-item mx-auto"><a class="nav-link" href="/posts/index">Strona główna</a></li>
      <li class="nav-item mx-auto"><a class="nav-link" href="/posts/income">Dodaj przychód</a></li>
      <li class="nav-item mx-auto"><a class="nav-link" href="/posts/expense">Dodaj wydatek</a></li>
      <li class="nav-item mx-auto"><a class="nav-link" href="/balance/balance">Przeglądaj bilans</a></li>
      <li class="nav-item mx-auto"><a class="nav-link active" href="/settings/settings">Ustawienia</a></li>
      <li class="nav-item mx-auto"><a class="nav-link" href="/logout">Wyloguj się</a></li>
    </ol>
  </div>
</nav>

{% endblock %}

{% block body %}

<div id="content_balance" style="min-height: 70vh">
  <div class="container">
    <div class="row justify-content-center">
      <div id="title" class="col-12 text-center mt-3">
        Panel użytkownika
        <hr class="line mt-4 mb-5" style="width: 60vmin">
      </div>
      <div id="accordion">
        <div class="card">
          <div class="card-header">
            <a class="collapsed card-link block_option" id="option1" data-toggle="collapse" href="#collapseOne">
              Kategorie przychodów
              <i class="icon-down-open" aria-hidden="true" id="up1"></i>
            </a>
          </div>
          <div id="collapseOne" class="collapse" data-parent="#accordion">
            <div class="card-body">
              <div class="info_edition mb-2">Edytuj istniejące kategorie:</div>
              {% for category in categoriesIncomes %}
              <label class="subblock_option col-12" id="labelIncome{{category[1]}}">
                <div>
                  <input class="mr-2" type="radio" name="categoryIncome">
                  {{ category[0] }}
                  </input>
                </div>
                <div>
                  <i class="icon-pencil pointer" id='{{category[0]}}' aria-hidden="true" title="Edytuj kategorię"></i>
                  <i class="icon-trash pointer" onclick="showModalToRemoveCategory('Income', '{{category[1]}}')"
                    aria-hidden="true" title="Usuń kategorię"></i>
                </div>
              </label>
              <div class="modal" tabindex="-1" role="dialog" id="winIncomeModal{{category[1]}}">
                <div class="modal-dialog" role="document">
                  <div class="modal-content p-3">
                    <div class="modal-header">
                      <h5 class="modal-title text-body h5">Usuwanie kategorii przychodów</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <form method="post" class="removeIncomeCategory">
                      <div class="modal-body text-body h6 mt-3 mb-3">
                        <p>Czy napewno chcesz usunąć poniższą kategorię? </p>
                        <p><b>{{category[0]}}</b></p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Nie</button>
                        <button type="submit" class="btn btn-primary">Tak</button>
                      </div>
                    </form>

                  </div>
                </div>
              </div>
              {% endfor %}
              <div class="text-right">
                <button class="btn_settings mt-3" onclick="showModalToAddCategory('Income')">
                  <i class="icon-plus pointer" aria-hidden="true"></i>
                  Dodaj nową kategorię
                </button>
              </div>
              <div class="modal" tabindex="-1" role="dialog" id="winModalAddCategoryIncome">
                <div class="modal-dialog" role="document">
                  <div class="modal-content p-3">
                    <div class="modal-header">
                      <h5 class="modal-title text-body h5">Dodawanie kategorii przychodów</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <form method="post" id="formAddCategoryIncome">
                      <div class="modal-body text-body h6 mt-3 mb-3">
                        <p>Wpisz nazwę kategorii: </p>
                        <input id="inputAddCategoryIncome" class="form-control" class="mt-3 mb-3" type="text">
                        <small><div class="categoryInfo mt-3 text-danger"></div></small>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-primary">Dodaj</button>
                      </div>
                    </form>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <a class="collapsed card-link block_option" id="option2" data-toggle="collapse" href="#collapseTwo">
              Kategorie wydatków
              <i class="icon-down-open" aria-hidden="true" id="up2"></i>
            </a>
          </div>
          <div id="collapseTwo" class="collapse" data-parent="#accordion">
            <div class="card-body">
              <div class="info_edition mb-2">Istniejące kategorie:</div>
              {% for category in categoriesExpenses %}
              <label class="subblock_option col-12" id="labelExpense{{category[1]}}">
                <div>
                  <input class="mr-2" type="radio" name="categoryExpense">
                  {{ category[0] }}
                  </input>
                </div>
                <div>
                  <i class="icon-pencil pointer" aria-hidden="true" title="Edytuj kategorię"></i>
                  <i class="icon-trash pointer" onclick="showModalToRemoveCategory('Expense', '{{category[1]}}')"
                    aria-hidden="true" title="Usuń kategorię"></i>
                </div>
              </label>
              <div class="modal" tabindex="-1" role="dialog" id="winExpenseModal{{category[1]}}">
                <div class="modal-dialog" role="document">
                  <div class="modal-content p-3">
                    <div class="modal-header">
                      <h5 class="modal-title text-body h5">Usuwanie kategorii wydatków</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <form method="post" class="removeExpenseCategory">
                      <div class="modal-body text-body h6 mt-3 mb-3">
                        <p>Czy napewno chcesz usunąć poniższą kategorię? </p>
                        <strong>{{category[0]}}</strong>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Nie</button>
                        <button type="submit" class="btn btn-primary">Tak</button>
                      </div>
                    </form>

                  </div>
                </div>
              </div>
              {% endfor %}
              <div class="text-right">
                <button class="btn_settings mt-3" onclick="showModalToAddCategory('Expense')">
                  <i class="icon-plus" aria-hidden="true"></i>
                  Dodaj nową kategorię
                </button>
              </div>
              <div class="modal" tabindex="-1" role="dialog" id="winModalAddCategoryExpense">
                <div class="modal-dialog" role="document">
                  <div class="modal-content p-3">
                    <div class="modal-header">
                      <h5 class="modal-title text-body h5">Dodawanie kategorii wydatków</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <form method="post" id="formAddCategoryExpense">
                      <div class="modal-body text-body h6 mt-3 mb-3">
                        <p>Wpisz nazwę kategorii: </p>
                        <input id="inputAddCategoryExpense" class="form-control" class="mt-3 mb-3" type="text">
                        <small><div class="categoryInfo mt-3 text-danger"></div></small>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-primary">Dodaj</button>
                      </div>
                    </form>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <a class="collapsed card-link block_option" id="option3" data-toggle="collapse" href="#collapseThree">
              Sposoby płatności
              <i class="icon-down-open" aria-hidden="true" id="up3"></i>
            </a>
          </div>
          <div id="collapseThree" class="collapse" data-parent="#accordion">
            <div class="card-body">
              <div class="info_edition mb-2">Istniejące metody:</div>
              {% for method in paymentMethods %}
              <label class="subblock_option col-12" id="labelPayment{{method[1]}}">
                <div>
                  {{ method[0]  }}
                </div>
                <div>
                  <i class="icon-pencil pointer" aria-hidden="true" title="Edytuj metodę"></i>
                  <i class="icon-trash pointer" onclick="showModalToRemoveCategory('Payment', '{{method[1]}}')"
                    aria-hidden="true" title="Usuń metodę"></i>
                </div>
              </label>
              <div class="modal" tabindex="-1" role="dialog" id="winPaymentModal{{method[1]}}">
                <div class="modal-dialog" role="document">
                  <div class="modal-content p-3">
                    <div class="modal-header">
                      <h5 class="modal-title text-body h5">Usuwanie metod płatności</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <form method="post" class="removePaymentCategory">
                      <div class="modal-body text-body h6 mt-3 mb-3">
                        <p>Czy napewno chcesz usunąć poniższą metodę? </p>
                        <strong>{{method[0]}}</strong>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Nie</button>
                        <button type="submit" class="btn btn-primary">Tak</button>
                      </div>
                    </form>

                  </div>
                </div>
              </div>
              {% endfor %}
              <div class="text-right">
                <button type="button" class="btn_settings mt-3" onclick="showModalToAddCategory('Payment')">
                  <i class="icon-plus pointer" aria-hidden="true"></i>
                  Dodaj metodę płatności
                </button>
              </div>
              <div class="modal" tabindex="-1" role="dialog" id="winModalAddCategoryPayment">
                <div class="modal-dialog" role="document">
                  <div class="modal-content p-3">
                    <div class="modal-header">
                      <h5 class="modal-title text-body h5">Dodawanie metod płatności</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <form method="post" id="formAddCategoryPayment">
                      <div class="modal-body text-body h6 mt-3 mb-3">
                        <p>Wpisz nazwę metody: </p>
                        <input id="inputAddCategoryPayment" class="form-control" class="mt-3 mb-3" type="text">
                        <small><div class="categoryInfo mt-3 text-danger"></div></small>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-primary">Dodaj</button>
                      </div>
                    </form>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <a class="collapsed card-link block_option" id="option4" data-toggle="collapse" href="#collapseFour">
              Konto
              <i class="icon-down-open" aria-hidden="true" id="up4"></i>
            </a>
          </div>
          <div id="collapseFour" class="collapse" data-parent="#accordion">
            <div class="card-body">
              Lorem ipsum..
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}